name: Build & Deploy to Test Environment
on:
  workflow_dispatch:
  push:
    branches:
      - development

jobs:
  build-code:
    runs-on: self-hosted
    outputs:
      commit_sha: ${{ steps.extract-sha.outputs.commit_sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Save commit SHA
        id: extract-sha
        run: echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build project
        run: |
          npm install
          npm run build-k8s

      - name: Upload dist files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodejs-publish
          path: ./dist

  build-container:
    runs-on: self-hosted
    needs: build-code

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Download publish artifact
        uses: actions/download-artifact@v4
        with:
          name: nodejs-publish
          path: ./dist

      - name: Build docker images
        run: |
          docker build -t kafein.azurecr.io/kafein-kstars/frontend:latest -t kafein.azurecr.io/kafein-kstars/frontend:${{ needs.build-code.outputs.commit_sha }}-$GITHUB_RUN_ID -f docker/Dockerfile .
          docker push kafein.azurecr.io/kafein-kstars/frontend:latest
          docker push kafein.azurecr.io/kafein-kstars/frontend:${{ needs.build-code.outputs.commit_sha }}-$GITHUB_RUN_ID
          docker rmi kafein.azurecr.io/kafein-kstars/frontend:latest
          docker rmi kafein.azurecr.io/kafein-kstars/frontend:${{ needs.build-code.outputs.commit_sha }}-$GITHUB_RUN_ID

  deploy:
    runs-on: self-hosted
    needs:
      - build-code
      - build-container
    env:
      COMMIT_SHA: ${{ needs.build-code.outputs.commit_sha }}
      ARGOCD_REPO: git@github.com:kafeinarge/portal-argocd.git
      BASE_PATH: apps/kstars

    steps:
      - name: Change image in argocd repo
        run: |
          set -e

          git clone $ARGOCD_REPO
          cd portal-argocd/

          git config --global user.name "Github Action Automation"
          git config --global user.email "github_action_test_env@kafein.com.tr"

          yq eval '.spec.template.spec.containers.0.image = "kafein.azurecr.io/kafein-kstars/frontend:${{ needs.build-code.outputs.commit_sha }}-" + strenv(GITHUB_RUN_ID)' -i $BASE_PATH/frontend/test/deployment.yaml

          echo "Pushing changes..."
          git add .
          git commit -m "deployment: Image tag changed with ${{ needs.build-code.outputs.commit_sha }}-$GITHUB_RUN_ID"
          git push origin main

      - name: Trigger ArgoCD with cli
        run: |
          argocd app sync kstars-frontend-test \
            --force \
            --insecure \
            --grpc-web \
            --server argocd.test.portal.kafein.com.tr \
            --auth-token ${{ secrets.ARGOCD_TEST_TOKEN }}

      - name: Wait for applications up and healthy
        run: |
          argocd app wait kstars-frontend-test \
            --health \
            --timeout 300 \
            --insecure \
            --grpc-web \
            --server argocd.test.portal.kafein.com.tr \
            --auth-token ${{ secrets.ARGOCD_TEST_TOKEN }}
